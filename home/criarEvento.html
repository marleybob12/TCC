<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Criar Evento</title>
  <link rel="stylesheet" href="../css/criarEvento.css" />
  <style>
    #previewBanner {
      display: none;
      max-width: 300px;
      margin-top: 10px;
      border-radius: 10px;
    }
    .mensagem {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-container">
      <div class="logo">
        <img src="../img/logo_barra.png" alt="EventFlow Logo">
      </div>
      <nav>
        <ul id="navList">
          <li><a href="../home/home.html">Home</a></li>
          <li><a href="../eventos/meusEventos.html">Meus Eventos</a></li>
          <li class="user-dropdown">
            <div class="user-account">
              <img id="userPhoto" src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="Usuário">
              <span id="userName">Usuário</span>
            </div>
            <div class="dropdown-menu">
              <a href="../perfil/perfil.html">Perfil</a>
              <a href="#" id="logoutBtn">Sair</a>
            </div>
          </li>
        </ul>
      </nav>
      <button class="menu-icon" id="menuToggle">&#9776;</button>
    </div>
  </header>

  <h1 style="text-align:center; margin-top:20px; color:#1673ff;">Criar Evento</h1>

  <form id="formCriarEvento">
    <h2>Dados do Organizador</h2>
    <div class="form-group">
      <label>Nome:</label>
      <input type="text" id="nomeUsuario" class="form-control" required/>
    </div>
    <div class="form-group">
      <label>CPF :</label>
      <input type="text" id="cpfUsuario" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Telefone:</label>
      <input type="text" id="telefoneUsuario" class="form-control" required />
    </div>
    <h2>Dados do Evento</h2>
    <div class="form-group">
      <label>Nome do Evento:</label>
      <input type="text" id="nomeEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Descrição:</label>
      <textarea id="descricaoEvento" class="form-control" required></textarea>
    </div>
    <div class="form-group">
      <h2>Data e hora do evento</h2>
      <label>Data:</label>
      <input type="date" id="dataEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Hora:</label>
      <input type="time" id="horaEvento" class="form-control" required />
    </div>
    <h2>Ingressos</h2>
    <div class="form-group">
      <label>Preço:</label>
      <input type="number" id="precoEvento" class="form-control" min="0" required />
    </div>
    <div class="form-group">
      <label>Quantidade de Ingressos:</label>
      <input type="number" id="quantidadeEvento" class="form-control" min="1" required />
    </div>
    <h2>Local do Evento</h2>
    <div class="form-group">
      <label>Endereço:</label>
      <input type="text" id="enderecoEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>CEP:</label>
      <input type="text" id="cepEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Categoria (Tipo de Evento):</label>
      <input type="text" id="tipoEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>CNPJ (Opcional):</label>
      <input type="text" id="cnpjEvento" class="form-control" placeholder="00.000.000/0000-00" />
    </div>
    <div class="form-group">
      <label>Banner (arquivo):</label>
      <input type="file" id="bannerArquivo" class="form-control" accept="image/*" />
      <img id="previewBanner" alt="Pré-visualização do Banner" />
    </div>

    <button type="submit" class="btn">Criar Evento</button>
    <p id="mensagem" class="mensagem"></p>
  </form>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { inserirDadosComOrganizador } from "../js/inserirDados.js";
    import { db } from "../firebaseConfig.js";

    const auth = getAuth();
    const storage = getStorage();
    const form = document.getElementById("formCriarEvento");
    const bannerInput = document.getElementById("bannerArquivo");
    const previewBanner = document.getElementById("previewBanner");
    const mensagemEl = document.getElementById("mensagem");

    // Menu responsivo
    document.getElementById("menuToggle").addEventListener("click", () => {
      document.getElementById("navList").classList.toggle("show");
    });

    // Dropdown usuário
    document.querySelector(".user-dropdown").addEventListener("click", () => {
      document.querySelector(".user-dropdown").classList.toggle("active");
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    // Preview do banner
    bannerInput.addEventListener("change", () => {
      const file = bannerInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          previewBanner.src = reader.result;
          previewBanner.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        previewBanner.style.display = "none";
      }
    });

    // Preencher dados do organizador e promover participante
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Você precisa estar logado para criar eventos.");
        window.location.href = "../login.html";
        return;
      }

      const userRef = doc(db, "Usuario", user.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.exists() ? userSnap.data() : {};

      document.getElementById("nomeUsuario").value = userData.nome || "Organizador";
      document.getElementById("cpfUsuario").value = userData.cpf || "00000000000";
      document.getElementById("telefoneUsuario").value = userData.telefone || "";
      document.getElementById("dataNascimentoUsuario").value = userData.dataNascimento || "1990-01-01";
      document.getElementById("userName").textContent = userData.nome || "Usuário";
      document.getElementById("userPhoto").src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/747/747376.png";
    });

    // Submit do formulário
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      mensagemEl.textContent = "";

      const eventoData = {
        nome: document.getElementById("nomeEvento").value.trim(),
        descricao: document.getElementById("descricaoEvento").value.trim(),
        data: document.getElementById("dataEvento").value,
        hora: document.getElementById("horaEvento").value,
        preco: parseFloat(document.getElementById("precoEvento").value),
        quantidade: parseInt(document.getElementById("quantidadeEvento").value, 10),
        endereco: document.getElementById("enderecoEvento").value.trim(),
        cep: document.getElementById("cepEvento").value.trim(),
        tipo: document.getElementById("tipoEvento").value.trim(),
        cnpj: document.getElementById("cnpjEvento").value.trim() || null,
        bannerUrl: ""
      };

      if (eventoData.preco < 0 || eventoData.quantidade < 1) {
        mensagemEl.textContent = "❌ Preço ou quantidade inválidos!";
        mensagemEl.style.color = "red";
        return;
      }

      try {
        // Upload banner
        const bannerArquivo = bannerInput.files[0];
        if (bannerArquivo) {
          const storageRef = ref(storage, `banners/${auth.currentUser.uid}_${Date.now()}_${bannerArquivo.name}`);
          await uploadBytes(storageRef, bannerArquivo);
          eventoData.bannerUrl = await getDownloadURL(storageRef);
        }

        // Inserir dados no Firestore
        await inserirDadosComOrganizador(
          db,
          auth.currentUser.uid,
          document.getElementById("nomeUsuario").value,
          auth.currentUser.email,
          document.getElementById("telefoneUsuario").value,
          document.getElementById("cpfUsuario").value,
          document.getElementById("dataNascimentoUsuario").value,
          eventoData
        );

        mensagemEl.textContent = "✅ Evento criado com sucesso!";
        mensagemEl.style.color = "#2F78E3";
        form.reset();
        previewBanner.style.display = "none";

      } catch (error) {
        console.error(error);
        mensagemEl.textContent = "❌ Erro ao criar evento. Veja o console.";
        mensagemEl.style.color = "red";
      }
    });
  </script>

</body>
</html>
