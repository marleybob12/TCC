<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Criar Evento</title>
  <link rel="stylesheet" href="../css/criarEvento.css" />
  <style>
    #previewBanner {
      display: none;
      max-width: 300px;
      margin-top: 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header>
    <div class="header-container">
      <div class="logo">
        <img src="../logo_colorida_cortada.png" alt="EventFlow Logo">
      </div>
      <nav>
        <ul id="navList">
          <li><a href="../home/home.html">Home</a></li>
          <li><a href="../eventos/meusEventos.html">Meus Eventos</a></li>
          <li class="user-dropdown">
            <div class="user-account">
              <img id="userPhoto" src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="Usuário">
              <span id="userName">Usuário</span>
            </div>
            <div class="dropdown-menu">
              <a href="../perfil/perfil.html">Perfil</a>
              <a href="#" id="logoutBtn">Sair</a>
            </div>
          </li>
        </ul>
      </nav>
      <button class="menu-icon" id="menuToggle">&#9776;</button>
    </div>
  </header>

  <h1 style="text-align:center; margin-top:20px; color:#1673ff;">Criar Evento</h1>

  <form id="formCriarEvento">
    <!-- Dados do Organizador -->
    <h2>Dados do Organizador</h2>
    <div class="form-group">
      <label>Nome:</label>
      <input type="text" id="nomeUsuario" class="form-control" disabled />
    </div>
    <div class="form-group">
      <label>CPF:</label>
      <input type="text" id="cpfUsuario" class="form-control" disabled />
    </div>
    <div class="form-group">
      <label>Telefone:</label>
      <input type="text" id="telefoneUsuario" class="form-control" disabled />
    </div>
    <div class="form-group">
      <label>Data de Nascimento:</label>
      <input type="date" id="dataNascimentoUsuario" class="form-control" disabled />
    </div>

    <!-- Dados do Evento -->
    <h2>Dados do Evento</h2>
    <div class="form-group">
      <label>Nome do Evento:</label>
      <input type="text" id="nomeEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Descrição:</label>
      <textarea id="descricaoEvento" class="form-control" required></textarea>
    </div>
    <div class="form-group">
      <label>Data:</label>
      <input type="date" id="dataEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Hora:</label>
      <input type="time" id="horaEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Preço:</label>
      <input type="number" id="precoEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Quantidade de Ingressos:</label>
      <input type="number" id="quantidadeEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Local:</label>
      <input type="text" id="localEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Endereço:</label>
      <input type="text" id="enderecoEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>CEP:</label>
      <input type="text" id="cepEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Categoria (Tipo de Evento):</label>
      <input type="text" id="tipoEvento" class="form-control" required />
    </div>
    <div class="form-group">
      <label>Banner (arquivo):</label>
      <input type="file" id="bannerArquivo" class="form-control" accept="image/*" />
      <img id="previewBanner" alt="Pré-visualização do Banner" />
    </div>

    <button type="submit" class="btn">Criar Evento</button>
  </form>

  <script type="module">
    import { db } from "../firebaseConfig.js";
    import { inserirDadosComOrganizador } from "../js/inserirDados.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const auth = getAuth();
    const storage = getStorage();
    const form = document.getElementById("formCriarEvento");
    const bannerInput = document.getElementById("bannerArquivo");
    const previewBanner = document.getElementById("previewBanner");

    // Menu responsivo
    const menuToggle = document.getElementById("menuToggle");
    const navList = document.getElementById("navList");
    menuToggle.addEventListener("click", () => {
      navList.classList.toggle("show");
    });

    // Dropdown usuário
    const userDropdown = document.querySelector(".user-dropdown");
    userDropdown.addEventListener("click", () => {
      userDropdown.classList.toggle("active");
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    // Preview do banner
    bannerInput.addEventListener("change", () => {
      const file = bannerInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          previewBanner.src = reader.result;
          previewBanner.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        previewBanner.style.display = "none";
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Você precisa estar logado para criar eventos.");
        window.location.href = "../login.html";
        return;
      }

      const userDoc = await getDoc(doc(db, "Usuario", user.uid));
      const userData = userDoc.exists() ? userDoc.data() : {};

      // Preencher dados do organizador
      document.getElementById("nomeUsuario").value = userData.nome || "Organizador";
      document.getElementById("cpfUsuario").value = userData.cpf || "00000000000";
      document.getElementById("telefoneUsuario").value = userData.telefone || "";
      document.getElementById("dataNascimentoUsuario").value = userData.dataNascimento || "1990-01-01";
      document.getElementById("userName").textContent = userData.nome || "Usuário";
      document.getElementById("userPhoto").src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/747/747376.png";

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        let bannerUrl = "";
        const bannerArquivo = bannerInput.files[0];
        if (bannerArquivo) {
          const storageRef = ref(storage, `banners/${user.uid}_${Date.now()}_${bannerArquivo.name}`);
          await uploadBytes(storageRef, bannerArquivo);
          bannerUrl = await getDownloadURL(storageRef);
        }

        const eventoData = {
          nome: document.getElementById("nomeEvento").value,
          descricao: document.getElementById("descricaoEvento").value,
          data: document.getElementById("dataEvento").value,
          hora: document.getElementById("horaEvento").value,
          preco: parseFloat(document.getElementById("precoEvento").value),
          quantidade: parseInt(document.getElementById("quantidadeEvento").value),
          local: document.getElementById("localEvento").value,
          endereco: document.getElementById("enderecoEvento").value,
          cep: document.getElementById("cepEvento").value,
          tipo: document.getElementById("tipoEvento").value,
          bannerUrl
        };

        try {
          await inserirDadosComOrganizador(
            db,
            user.uid,
            userData.nome || "Organizador",
            user.email,
            userData.telefone || null,
            userData.cpf || "00000000000",
            userData.dataNascimento || "1990-01-01",
            eventoData
          );
          alert("✅ Evento criado com sucesso!");
          form.reset();
          previewBanner.style.display = "none";
        } catch (error) {
          alert("❌ Erro ao criar evento. Veja o console.");
          console.error(error);
        }
      });
    });
  </script>
</body>
</html>
